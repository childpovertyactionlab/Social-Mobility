---
title: "Social Mobility: Pre-Processing"
subtitle: "Step 02: ACS Data Transformation"
author: "Michael Lopez"
date: "`r format(Sys.Date(), '%B, %d, %Y'`"
output: 
  github_document: default
    toc: true
    number_sections: true
    toc_float: true
    theme: pagedown::architect
    code_folding: show
---

---
title: "Social Mobility: Pre-Processing"
subtitle: "Step 02: ACS Data to geoJSON"
author: "Michael Lopez"
date: "`r format(Sys.Date(), '%B, %d, %Y'`"
output: 
  github_document: default
    toc: true
    number_sections: true
    toc_float: true
    theme: pagedown::architect
    code_folding: show
---

```{r setup, include = FALSE, echo = FALSE}
rm(list=ls(all=TRUE))
knitr::opts_knit$set(root.dir = 'C:/Users/Michael Lopez/Documents/GitHub')
#knitr::opts_knit$set(root.dir = 'C:/Users/OwenWilson-Chavez/CPAL Dropbox')
getwd()
library(tidyverse)
library(rio)
library(sf)
```

```{r directory test}
getwd()
```

```{r import geography data, echo=FALSE}
#import acs data
sm_zcta <- st_read("Social-Mobility/Data/Intermediate/sm_zcta.geojson")
sm_places <- st_read("Social-Mobility/Data/Intermediate/sm_places.geojson")
sm_tracts <- st_read("Social-Mobility/Data/Intermediate/sm_tracts.geojson")
sm_counties <- st_read("Social-Mobility/Data/Intermediate/sm_counties.geojson")

#delete unnecessary columns
names(sm_zcta)
zip.select <- sm_zcta %>%
  select(fid, NAME, GEOID10, ALAND10, AWATER10, INTPTLAT10, INTPTLON10, tot_popE_18:geometry) %>%
  rename(GEOID = GEOID10,
         ALAND = ALAND10,
         AWATER = AWATER10,
         INTPTLAT = INTPTLAT10,
         INTPTLON = INTPTLON10)

names(sm_places)
place.select <- sm_places %>%
  select(fid, GEOID, NAME.x, ALAND:INTPTLON, tot_popE_18:geometry) %>%
  rename(NAME = NAME.x)

names(sm_tracts)
tract.select <- sm_tracts %>%
  select(fid, GEOID, NAME.x, ALAND:INTPTLON, tot_popE_18:geometry) %>%
  rename(NAME = NAME.x)

names(sm_counties)
county.select <- sm_counties %>%
  select(fid, GEOID, NAME.x, ALAND:INTPTLON, tot_popE_18:geometry) %>%
  rename(NAME = NAME.x)

rm(sm_zcta)
rm(sm_places)
rm(sm_tracts)
rm(sm_counties)
```

```{r import raw data, echo=FALSE}
setwd("E:/CPAL Dropbox") #Michael
#setwd("C:/Users/OwenWilson-Chavez/CPAL Dropbox") #Owen

renter <- import("Data Library/Urban Institute/Rental Assistance Priority Index/housing_index_state_adj.csv")

precincts_dallas <- st_read("Data Library/Texas Elections/Dallas County Elections/Precinct Shapefiles/Precinct13.shp")

vote2016 <- import("Data Library/Texas Elections/Dallas County Elections/Votes by Precinct/2016_Vote_byPrecinct_DallasCounty.csv")
#vote2018 <- import("Data Library/Dallas County Elections/Votes by Precinct/2018_Vote_byPrecinct_DallasCounty.csv")
vote2020 <- import("Data Library/Texas Elections/Dallas County Elections/Votes by Precinct/2020_Vote_byPrecinct_DallasCounty.csv")

```

```{r housing vouchers}
names(housing_vouchers)
housing_lim <- as.data.frame(housing_vouchers) %>%
  select(GEOID, HCV_PUBLIC) %>%
  mutate(GEOID = as.numeric(GEOID))
  
tract_housing <- left_join(tract.select, housing_lim)

rm(housing_vouchers)
rm(housing_lim)
```

```{r renter instability}
names(renter)

renter_lim <- renter %>%
  select(GEOID, housing_index) %>%
  mutate(GEOID = as.numeric(GEOID)) %>%
  rename(rent_instability = housing_index)

tract_rent <- left_join(tract.select, renter_lim)

rm(renter_lim)
rm(renter)
```

```{r voter data Dallas County}
names(precincts_dallas)
precincts_dallas <- precincts_dallas %>%
  select(FID_Precin, PCT, geometry) %>%
  rename(precinct = PCT,
         FID = FID_Precin)

vote2016 <- vote2016 %>%
  mutate(precinct = str_sub(precinct, 1, 4)) %>%
  select(precinct, total_ballots, registered_voters) %>%
  group_by(precinct) %>%
  summarise(total_ballots_2016 = sum(total_ballots),
            registered_voters_2016 = sum(registered_voters),
            turnout_2016 = total_ballots_2016/registered_voters_2016) %>%
  drop_na() %>%
  filter(!is.infinite(turnout_2016))

vote2020 <- vote2020 %>%
  mutate(precinct = str_sub(precinct, 1, 4)) %>%
  select(precinct, total_ballots, registered_voters) %>%
  group_by(precinct) %>%
  summarise(total_ballots_2020 = sum(total_ballots),
            registered_voters_2020 = sum(registered_voters),
            turnout_2020 = total_ballots_2020/registered_voters_2020) %>%
  drop_na() %>%
  filter(!is.infinite(turnout_2020))

vote_change <- vote2020 %>%
  full_join(., vote2016) %>%
  mutate(turnout_dif = turnout_2020-turnout_2016) %>%
  left_join(precincts_dallas, .)

geojsonio::geojson_write(vote2016, file = "Social-Mobility/Data/geojson/vote_2016.geojson")
geojsonio::geojson_write(vote2020, file = "Social-Mobility/Data/geojson/vote_2020.geojson")
```

```{r join to each other}
new_tract_var <- tract_rent %>%
  left_join(.,  as.data.frame(tract_housing)) %>%
  mutate(per_tot_pop = hablar::rationalize(as.numeric(per_tot_pop)))

new_zip_var <- zip.select %>%
  mutate(per_cbp = hablar::rationalize(as.numeric(per_cbp)),
         GEOID = as.integer(GEOID))

new_place_var <- place.select 

new_county_var <- county.select

```

```{r acs modifications}
names(new_tract_var)
belpov <- new_tract_var %>%
  filter(bp_per_18 >= 0.4) %>%
  select(pop_bpE_18,geometry) %>%
  rename(bp_o40 = pop_bpE_18)

new_zip_var <- zip.select %>%
  select(GEOID, tot_popE_18, geometry) %>%
  st_intersection(., belpov) %>%
  group_by(GEOID) %>%
  summarise(bp_o40 = sum(bp_o40),
            tot_popE_18 = sum(tot_popE_18)) %>%
  mutate(bp_o40per = bp_o40/tot_popE_18)

new_place_var <- place.select %>%
  select(GEOID, tot_popE_18, geometry) %>%
  st_intersection(., belpov) %>%
  group_by(GEOID) %>%
  summarise(bp_o40 = sum(bp_o40),
            tot_popE_18 = sum(tot_popE_18)) %>%
  mutate(bp_o40per = bp_o40/tot_popE_18)

new_county_var <-  county.select %>%
  select(GEOID, tot_popE_18, geometry) %>%
  st_intersection(., belpov) %>%
  group_by(GEOID) %>%
  summarise(bp_o40 = sum(bp_o40),
            tot_popE_18 = sum(tot_popE_18)) %>%
  mutate(bp_o40per = bp_o40/tot_popE_18)
  
```

Function which will group each variable into bins between 0 and 4 based on the standard deviation of each variable.
Cuts occur at +/- 0.5 standard deviations and +/- 1 standard deviation.
```{r sdcut function}
sdcut <- function(x) {
  sd1p <- mean(x, na.rm = TRUE)+(sd(x, na.rm = TRUE)*0.50)
  sd1n <- mean(x, na.rm = TRUE)-(sd(x, na.rm = TRUE)*0.50)
  sd2p <- mean(x, na.rm = TRUE)+(sd(x, na.rm = TRUE)*1)
  sd2n <- mean(x, na.rm = TRUE)-(sd(x, na.rm = TRUE)*1)
  ifelse(x > sd2p, 4,
         ifelse(x > sd1p & x < sd2p, 3,
                ifelse(x > sd1n & x < sd1p, 2,
                       ifelse(x > sd2n & x < sd1n, 1, 0))))
}
```

Convert all estimate variables by `log()` in order to then apply sdcut function.
```{r sdcut all geographies}
#zip codes
names(new_zip_var)
socmob.zip.sd <- as.data.frame(new_zip_var) %>%
  mutate_at(c(8:61), funs(c(sdcut(.)))) %>%
  setNames(c(names(.)[1], paste0(names(.)[-1],"_sd"))) %>%
  rename(NAME = NAME_sd,
         GEOID = GEOID_sd,
         ALAND = ALAND_sd,
         AWATER = AWATER_sd,
         INTPTLAT = INTPTLAT_sd,
         INTPTLON = INTPTLON_sd) %>%
  select(-geometry_sd)

socmob.zip.upload <- left_join(new_zip_var, socmob.zip.sd)

#places
socmob.place.sd <- as.data.frame(new_place_var) %>%
  mutate_at(c(8:61), funs(c(sdcut(.)))) %>%
  setNames(c(names(.)[1], paste0(names(.)[-1],"_sd"))) %>%
  rename(NAME = NAME_sd,
         GEOID = GEOID_sd,
         ALAND = ALAND_sd,
         AWATER = AWATER_sd,
         INTPTLAT = INTPTLAT_sd,
         INTPTLON = INTPTLON_sd) %>%
  select(-geometry_sd)

socmob.place.upload <- left_join(new_place_var, socmob.place.sd)

#tracts
socmob.tract.sd <- as.data.frame(new_tract_var) %>%
  mutate_at(c(8:64), funs(c(sdcut(.)))) %>%
  setNames(c(names(.)[1], paste0(names(.)[-1],"_sd"))) %>%
  rename(NAME = NAME_sd,
         GEOID = GEOID_sd,
         ALAND = ALAND_sd,
         AWATER = AWATER_sd,
         INTPTLAT = INTPTLAT_sd,
         INTPTLON = INTPTLON_sd) %>%
  select(-geometry_sd)

socmob.tract.upload <- left_join(new_tract_var, socmob.tract.sd)

rm(socmob.zip.sd)
rm(socmob.place.sd)
rm(socmob.tract.sd)
```

```{r descriptive stats}
socmob.calc <- full_join(full_join(full_join(as.data.frame(socmob.tract.upload), as.data.frame(socmob.zip.upload)), as.data.frame(socmob.place.upload)),as.data.frame(new_county_var))

var <-  c("nbr.val", "nbr.null", "nbr.na", "min", "max", "range", "sum", "median", "mean", "SE.mean", "CI.mean.0.95", "var", "std.dev", "coef.var")
socmob.calc.d <- cbind(var, pastecs::stat.desc(socmob.calc))

n <- socmob.calc.d$var

# transpose all but the first column (name)
socmob.calc.d <- as.data.frame(t(socmob.calc.d[,-1]))
colnames(socmob.calc.d) <- n
socmob.calc.d$variable <- factor(row.names(socmob.calc.d))
socmob.calc.d <- socmob.calc.d %>%
  select(variable, min, max, range, mean)

datadic <- import("Social-Mobility/DataDictionary.csv")
datadic_join <- datadic %>%
  select(variable:highisgood) %>%
  full_join(., socmob.calc.d)
```

```{r geojson export}
setwd("C:/Users/Michael Lopez/Documents/GitHub")
#export(datadic_join, "Social-Mobility/DataDictionary.csv")
geojsonio::geojson_write(socmob.zip.upload, file = "Social-Mobility/Data/geojson/sm_zcta.geojson")
geojsonio::geojson_write(socmob.place.upload, file = "Social-Mobility/Data/geojson/sm_places.geojson")
geojsonio::geojson_write(socmob.tract.upload, file = "Social-Mobility/Data/geojson/sm_tracts.geojson")
geojsonio::geojson_write(county.select, file = "Social-Mobility/Data/geojson/sm_counties.geojson")
```