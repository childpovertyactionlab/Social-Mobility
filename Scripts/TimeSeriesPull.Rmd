---
title: "NTX Child Poverty Over Time by Tract"
subtitle: "UNTD"
author: "Michael Lopez"
date: "`r format(Sys.Date(), '%B, %d, %Y'`"
output: 
  github_document: default
    toc: true
    number_sections: true
    toc_float: true
    theme: pagedown::architect
    code_folding: show
---

Load necessary libraries to import ACS census data with the tidycensus package.

```{r setup, include = FALSE, echo = FALSE}
rm(list=ls(all=TRUE))
knitr::opts_knit$set(root.dir = 'E:/CPAL Dropbox')
getwd()
library(tidycensus)
library(tidyverse)
library(rio)
library(sf)
library(ggthemes)
library(tigris)
library(directlabels)
```

```{r directory test, include = FALSE, echo = FALSE}
getwd()
```

```{r setup for graphs, include = FALSE, echo = FALSE}
acs_b <- load_variables(2015, "acs5", cache = TRUE)
acs_s <- load_variables(2019, "acs5/subject", cache = TRUE)
#view(acs18)
#data(fips_codes)
years_old <- lst(2012, 2013, 2014, 2015, 2016)
years_new <- lst(2017, 2018, 2019)

counties <- c("Dallas", "Tarrant", "Denton", "Collin", "Rockwall", "Kaufman", "Ellis", "Johnson")

###############################################################################################
###############################################################################################

CPAL.colors = c("#008097", "#ec008c", "#eaca2d", "#b4b4b4", "#9bd9e3", "#fdddd7")
CPAL.colors.Rev = c("#fdddd7", "#9bd9e3", "#b4b4b4", "#eaca2d", "#ec008c", "#008097")
Black = c("#000000", "#000000", "#000000")

###############################################################################################
###############################################################################################
theme_cpal <- function(base_size = 12, base_family = "sans") {
  colors <- deframe(ggthemes::ggthemes_data[["fivethirtyeight"]])
  (theme_foundation(base_size = base_size, base_family = base_family)
    + theme(
      line = element_line(colour = "#b4b4b4"),
      rect = element_rect(fill = "#ffffff",
                          linetype = 1, colour = NA),
      text = element_text(family = "Roboto", face = "bold", colour = "#6c6c6c"),
      axis.title = element_text(),
      axis.title.x = element_text(vjust = 2),
      axis.title.y = element_text(vjust = 2),
      axis.text = element_text(color = "#b4b4b4"),
      axis.ticks = element_blank(),
      #axis.ticks.length = unit(6, "pt"),
      axis.line = element_line(color = "#b4b4b4", size = 1.5, linetype = "solid"),
      legend.background = element_rect(),
      legend.position = "none",
      legend.direction = "horizontal",
      legend.box = "horizontal",
      panel.grid.major = element_line(colour = "#e1e1e1"),
      panel.grid.minor = element_blank(),
      plot.title = element_text(hjust = 0, size = rel(1.5), face = "bold"),
      plot.margin = unit(c(1, 6, 1, 1), "lines"),
      panel.border = element_rect(size=1, fill = NA),
      strip.background = element_rect()
    ))
}
###############################################################################################
###############################################################################################
```

```{r tidycensus variable selection, include = FALSE, echo = FALSE}
acs_new <- c(
  tot_pop = "B01003_001", #total population
  pop_u18 = "S0101_C01_022", #population under 18
  pop_bp = "S1701_C02_001", #population below poverty
  bp_u18 = "S1701_C02_002", #population under 18 below poverty
  med_inc = "B19013_001", #median household income
  gini = "B19083_001" #gini coefficient
  )

acs_old <- c(
  tot_pop = "B01003_001", #total population
  pop_u18 = "S1701_C01_002", #population under 18
  pop_bp = "S1701_C02_001", #population below poverty
  bp_u18 = "S1701_C02_002", #population under 18 below poverty
  med_inc = "B19013_001", #median household income
  gini = "B19083_001" #gini coefficient
  )
```

```{r pull variables from tidycensus, include = FALSE, echo = FALSE}
cpal_tract_old <- map(
  years_old,
  ~get_acs(
    geography = "tract",
    state = "TX",
    #county = counties,
    variables = acs_old,
    year = .x, 
    survey = "acs5", 
    output = "wide"),
) %>%
  map2(years_old, ~mutate(.x, year = .y)) %>%
  reduce(., rbind)

cpal_tract_new <- map(
  years_new,
  ~get_acs(
    geography = "tract",
    state = "TX",
    #county = counties,
    variables = acs_new,
    year = .x, 
    survey = "acs5", 
    output = "wide"),
) %>%
  map2(years_new, ~mutate(.x, year = .y)) %>%
  reduce(., rbind)

cpal_tract <- rbind(cpal_tract_old, cpal_tract_new)
rm(cpal_tract_new)
rm(cpal_tract_old)

untd_tract_long <- cpal_tract %>%
  filter(str_detect(NAME, str_c(counties, collapse = "|"))) %>%
  mutate(bp_per = pop_bpE/tot_popE,
         cbp_per = bp_u18E/pop_u18E,
         type = "Tract") %>%
  select(-ends_with("M"))

untd_tract_wide <- untd_tract_long %>%
  pivot_wider(names_from = "year", 
              values_from = c(tot_popE, med_incE, giniE, pop_u18E, pop_bpE, bp_u18E, bp_per, cbp_per))
```

```{r pull variables from tidycensus, include = FALSE, echo = FALSE}
zip <- import("C:/Users/Michael Lopez/Documents/GitHub/Social-Mobility/Data/Reference Geographies/socmob_zcta.csv") %>%
  select(ZIP) %>%
  rename(GEOID = ZIP) %>%
  mutate(GEOID = as.character(GEOID))

cpal_zip_old <- map(
  years_old,
  ~get_acs(
    geography = "zcta",
    variables = acs_old,
    year = .x, 
    survey = "acs5", 
    output = "wide"),
) %>%
  map2(years_old, ~mutate(.x, year = .y)) %>%
  reduce(., rbind)

cpal_zip_new <- map(
  years_new,
  ~get_acs(
    geography = "zcta",
    variables = acs_new,
    year = .x, 
    survey = "acs5", 
    output = "wide"),
) %>%
  map2(years_new, ~mutate(.x, year = .y)) %>%
  reduce(., rbind)

cpal_zip <- cpal_zip_old %>%
  mutate(GEOID = as.character(as.numeric(GEOID)-4800000)) %>%
  rbind(., cpal_zip_new) %>%
  inner_join(., zip)

rm(cpal_zip_new)
rm(cpal_zip_old)

untd_zip_long <- cpal_zip %>%
  mutate(bp_per = pop_bpE/tot_popE,
         cbp_per = bp_u18E/pop_u18E,
         type = "Zip") %>%
  select(-ends_with("M"))

untd_zip_wide <- untd_zip_long %>%
  pivot_wider(names_from = "year", 
              values_from = c(tot_popE, med_incE, giniE, pop_u18E, pop_bpE, bp_u18E, bp_per, cbp_per))
```

```{r pull variables from tidycensus, include = FALSE, echo = FALSE}
place <- import("C:/Users/Michael Lopez/Documents/GitHub/Social-Mobility/Data/Reference Geographies/socmob_place.csv") %>%
  select(GEOID) %>%
  mutate(GEOID = as.character(GEOID))

cpal_place_old <- map(
  years_old,
  ~get_acs(
    geography = "place",
    state = "TX",
    variables = acs_old,
    year = .x, 
    survey = "acs5", 
    output = "wide"),
) %>%
  map2(years_old, ~mutate(.x, year = .y)) %>%
  reduce(., rbind)

cpal_place_new <- map(
  years_new,
  ~get_acs(
    geography = "place",
    state = "TX",
    variables = acs_new,
    year = .x, 
    survey = "acs5", 
    output = "wide"),
) %>%
  map2(years_new, ~mutate(.x, year = .y)) %>%
  reduce(., rbind)

cpal_place <- rbind(cpal_place_old, cpal_place_new) %>%
  inner_join(place, .)

rm(cpal_place_new)
rm(cpal_place_old)

untd_place_long <- cpal_place %>%
  mutate(bp_per = pop_bpE/tot_popE,
         cbp_per = bp_u18E/pop_u18E,
         type = "Place") %>%
  select(-ends_with("M"))
names(untd_place_long)

untd_place_wide <- untd_place_long %>%
  pivot_wider(names_from = "year", 
              values_from = c(tot_popE, med_incE, giniE, pop_u18E, pop_bpE, bp_u18E, bp_per, cbp_per))
```

```{r pull variables from tidycensus, include = FALSE, echo = FALSE}
county_names <- c("Dallas County", 
                  "Rockwall County", 
                  "Collin County", 
                  "Denton County", 
                  "Tarrant County", 
                  "Kaufman County", 
                  "Ellis County", 
                  "Johnson County")

cpal_county_old <- map(
  years_old,
  ~get_acs(
    geography = "county",
    state = "TX",
    county = county_names,
    variables = acs_old,
    year = .x, 
    survey = "acs5", 
    output = "wide"),
) %>%
  map2(years_old, ~mutate(.x, year = .y)) %>%
  reduce(., rbind)

cpal_county_new <- map(
  years_new,
  ~get_acs(
    geography = "county",
    state = "TX",
    county = county_names,
    variables = acs_new,
    year = .x, 
    survey = "acs5", 
    output = "wide"),
) %>%
  map2(years_new, ~mutate(.x, year = .y)) %>%
  reduce(., rbind)

cpal_county <- rbind(cpal_county_old, cpal_county_new)

rm(cpal_county_new)
rm(cpal_county_old)

untd_county_long <- cpal_county %>%
  mutate(bp_per = pop_bpE/tot_popE,
         cbp_per = bp_u18E/pop_u18E,
         type = "County") %>%
  select(-ends_with("M"))

untd_county_wide <- untd_county_long %>%
  pivot_wider(names_from = "year", 
              values_from = c(tot_popE, med_incE, giniE, pop_u18E, pop_bpE, bp_u18E, bp_per, cbp_per))
```

```{r}
untd_wide <- full_join(full_join(full_join(untd_tract_wide, untd_zip_wide), untd_place_wide), untd_county_wide)

untd_long <- full_join(full_join(full_join(untd_tract_long, untd_zip_long), untd_place_long), untd_county_long)
```


```{r}
export(untd_tract_wide, "C:/Users/Michael Lopez/Documents/GitHub/Social-Mobility/Data/ACS/TimeSeriesbyTract_Wide.csv")
export(untd_tract_long, "C:/Users/Michael Lopez/Documents/GitHub/Social-Mobility/Data/ACS/TimeSeriesbyTract_Long.csv")

export(untd_zip_wide, "C:/Users/Michael Lopez/Documents/GitHub/Social-Mobility/Data/ACS/TimeSeriesbyZip_Wide.csv")
export(untd_zip_long, "C:/Users/Michael Lopez/Documents/GitHub/Social-Mobility/Data/ACS/TimeSeriesbyZip_Long.csv")

export(untd_place_wide, "C:/Users/Michael Lopez/Documents/GitHub/Social-Mobility/Data/ACS/TimeSeriesbyPlace_Wide.csv")
export(untd_place_long, "C:/Users/Michael Lopez/Documents/GitHub/Social-Mobility/Data/ACS/TimeSeriesbyPlace_Long.csv")

export(untd_county_wide, "C:/Users/Michael Lopez/Documents/GitHub/Social-Mobility/Data/ACS/TimeSeriesbyCounty_Wide.csv")
export(untd_county_long, "C:/Users/Michael Lopez/Documents/GitHub/Social-Mobility/Data/ACS/TimeSeriesbyCounty_Long.csv")

export(untd_wide, "C:/Users/Michael Lopez/Documents/GitHub/Social-Mobility/Data/ACS/TimeSeriesAllGeographies_Wide.csv")
export(untd_long, "C:/Users/Michael Lopez/Documents/GitHub/Social-Mobility/Data/ACS/TimeSeriesAllGeographies_Long.csv")
```