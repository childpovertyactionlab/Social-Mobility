---
title: "NTX Child Poverty Over Time by Tract"
subtitle: "UNTD"
author: "Michael Lopez"
date: "`r format(Sys.Date(), '%B, %d, %Y'`"
output: 
  github_document: default
    toc: true
    number_sections: true
    toc_float: true
    theme: pagedown::architect
    code_folding: show
---

Load necessary libraries to import ACS census data with the tidycensus package.

```{r setup, include = FALSE, echo = FALSE}
rm(list=ls(all=TRUE))
knitr::opts_knit$set(root.dir = 'E:/CPAL Dropbox')
getwd()
library(tidycensus)
library(tidyverse)
library(rio)
library(sf)
library(ggthemes)
library(tigris)
library(directlabels)
```

```{r directory test, include = FALSE, echo = FALSE}
getwd()
```

```{r setup for graphs, include = FALSE, echo = FALSE}
acs19_b <- load_variables(2019, "acs5", cache = TRUE)
acs19_s <- load_variables(2019, "acs5/subject", cache = TRUE)
#view(acs18)
#data(fips_codes)
years <- lst(2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019)
counties <- c("Dallas", "Tarrant", "Denton", "Collin", "Rockwall", "Kaufman", "Ellis", "Johnson")

###############################################################################################
###############################################################################################

CPAL.colors = c("#008097", "#ec008c", "#eaca2d", "#b4b4b4", "#9bd9e3", "#fdddd7")
CPAL.colors.Rev = c("#fdddd7", "#9bd9e3", "#b4b4b4", "#eaca2d", "#ec008c", "#008097")
Black = c("#000000", "#000000", "#000000")

###############################################################################################
###############################################################################################
theme_cpal <- function(base_size = 12, base_family = "sans") {
  colors <- deframe(ggthemes::ggthemes_data[["fivethirtyeight"]])
  (theme_foundation(base_size = base_size, base_family = base_family)
    + theme(
      line = element_line(colour = "#b4b4b4"),
      rect = element_rect(fill = "#ffffff",
                          linetype = 1, colour = NA),
      text = element_text(family = "Roboto", face = "bold", colour = "#6c6c6c"),
      axis.title = element_text(),
      axis.title.x = element_text(vjust = 2),
      axis.title.y = element_text(vjust = 2),
      axis.text = element_text(color = "#b4b4b4"),
      axis.ticks = element_blank(),
      #axis.ticks.length = unit(6, "pt"),
      axis.line = element_line(color = "#b4b4b4", size = 1.5, linetype = "solid"),
      legend.background = element_rect(),
      legend.position = "none",
      legend.direction = "horizontal",
      legend.box = "horizontal",
      panel.grid.major = element_line(colour = "#e1e1e1"),
      panel.grid.minor = element_blank(),
      plot.title = element_text(hjust = 0, size = rel(1.5), face = "bold"),
      plot.margin = unit(c(1, 6, 1, 1), "lines"),
      panel.border = element_rect(size=1, fill = NA),
      strip.background = element_rect()
    ))
}
###############################################################################################
###############################################################################################


rm(acs19_b)
rm(acs19_s)
```

```{r tidycensus variable selection, include = FALSE, echo = FALSE}
acs_var <- c(
  tot_pop = "B01003_001", #total population
  pop_u18 = "S0901_C01_001", #population under 18
  pop_bp = "S0101_C01_022", #population below poverty
  bp_u18 = "S1701_C02_002", #population under 18 below poverty
  cbp_per = "S1701_C03_002" #percent population under 18 below poverty
  )
```

```{r tract pull}
cpal_base <- get_acs(geography = "county", 
                     variables = acs_var,
                     year = 2019, 
                     survey = "acs5", 
                     output = "wide")
```

```{r pull variables from tidycensus, include = FALSE, echo = FALSE}
cpal_multi <- map(
  years,
  ~get_acs(
    geography = "tract",
    state = "TX",
    #county = counties,
    variables = acs_var,
    year = .x, 
    survey = "acs5", 
    output = "wide"),
) %>%
  map2(years, ~mutate(.x, year = .y)) %>%
  reduce(., rbind)

untd_counties <- cpal_multi %>%
  filter(str_detect(NAME, str_c(counties, collapse = "|")))
```

```{r}
export(untd_counties, "C:/Users/Michael Lopez/Documents/GitHub/Social-Mobility/Data/ACS/TimeSeriesbyTract_ChildPovertyRate.csv")
```